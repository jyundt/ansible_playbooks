apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: home-assistant
  namespace: default
spec:
  encryptedData:
    auth_provider.homeassistant: AgCJ5+sRQAGfeDphPUuGMrrK64pDf0kIj9yvpqZcUbTGMr+sP6rT3j5oNM7orsFXRVqiVPKd+EW6Y6m3+veFFlSUjNmix+I1cAbVZDNRP2/VVY8ElzRE3ZIl+d4GeGTn+v6cKrRdBlSKCWjRaeoAAEJVnQ4LhPVntgsNTRs6Lrg/hhpCPLVBoIL7q/zuIvnespd5hpy43V8oczlPbNqHLYB2LjTOncLNtXuRNLQ9tMlhT4oKtSukgyDaXaW2SMmnqW7Om/cvPhJf1gvonEKInLFvtnLcUZFDK7db6TR6A8a8+aW9BO70RU7XRvG7cQla27Etrw57CPoCswkbgZLBqK0rm0Wwg5PF3AExuC0eDorIYe3oxP2nVfM8eQu8YrJ9Ydm+e4B4ZDPkUaVBHUn357gcG+Ur4SIdnJRt7XIHrHip13agiDbRD+N7tfiDPQF1bYIntv6KWzLjogyPOABbw3I3US0NIfK/l4Wo57HoRXozjYbprK6AXey1swqqbz9RulFL4xweE8YYx/PH4a8CMaQNUXRd/+XALQQNeIGaiQK0J/OYRUMPgnNEbqhtba3VuzSsE0n9Ac4Xv9ZFUbgaX5rZjDEDyiivmJlK29W/3DYEqNO2o8cCZ1ZJD8OvM+07igN0zKl4WZvAElGhdnY6VqnLMM6HE2ufmziWrGiZhJ2EyxjXu1W39wBAUf49P4gYQonRlD7nqAhHU4Z42NCWI9KnxSRnJabEu23j62rDhtJJnTOEIApf0kZyrUYXmUzfMLSyl6TPu2uvwC/59snW2Jwi0V9BY7ZE0af5nLG9E4g36ajO+XzP6usIQ5y1RZhNUSGb5W/JjByvfVtGZCSXMPgBHuPNIita6G5e29I9Qi3opz7UJ+7Tybw1IW3uUGjvkP33+VRDIOzgeDXYdSSCDIKWCvTtc1u2RLIvvHYJEiU3bU6zymQBMjeiXQRbtuxsq9Hy8gT6/tgxNYfBUHQTyGQQOop7ak1Eg26UpPHmsz2d4wc4ao0DiYEnoB+5uNRFkSJflj+QjWKg5dHX7VqctZOxJSXut9kRVYUFL3iuEUwH0/lVJBIH1Zifv2HXFixTUJOZ87pOFL2VVoNAOB5woDvyLkoq7HVm5cmq+zRFqSQNQksJw0sJBON0bteHZzyA9SAIvs+48mkMhma7XvPVtsT09NY5JnExwi0Jv9q1KlPxzNU96XhK/v6Gz3k4D7Za+5j/+3IjbBFBZQ+iBPw9ymCBpKNamGdNtpziMX+qrnuY9Vk9P8yF4Kwo8Qrj9I/WaBtScq81PQGKlCGDz0H3Ku4m8flznYZqbQlQCD7EwxLLGnQnj0Tt05H9IKCk6Re0suMT0rnDYUxBZZlfjkLjzNtj66Jm15nYiPF6RkQwDk9PGSg9tpfc3lC4jlFGWq/A+FhxuhyO0Ki74kJAp97XUoiXOq+iLFgnJQ==
    secrets.yaml: AgAGAaAN4an4S1K58zrTmeI3vvtf1xIVAeGzSy0ajjCyChq9Mo8NpcEjHmtmkCuYfrPHWtAlrJajlKyTov4V1/DOA+TqOEx7osYTENBzcMq8Deddur9fpqh7F9bUy6p6Bc0/JJFUQOR6Bi5Yyeu0Fi8yD0Kz09w9+B98zJgNAQr7z4Wx1RzgfpXJyiiKRtaj2Pf0cggEWbmpYIsPiXzyIiWxK/kdn5v31uWkbspiDSd8s/fcWGqMOwACFkHgvAb614M5yo1FfRxAW5vMfeOdcNx4YckSgyla9xFbGj4MpjXZ37MYiyHjszPu/0HNq9TQYLc7YUPETnyLYVLXfIxw+Q6ovMvbxjDBHFuVr1yoHk9F1ip/4Um56XGHiMGUgfmocD5kZUV7YU0Trz82YNIjUHcu/0Rpcx7YZ7DLwIxD5S2x3CAuHXVCFgwBxulm63/KDLcmNUtxe9UVPtGnJrTclgnFa38I1eJ9MDu5txGcQduCK+P0oSwZSWvG2You2Dd9i55QGZImO8hqcpXazGxCmpp2VGvFKYfXlXePxDa2nkyoQp7Jw8VBHZf8X4P95azzJXPKiI7KrIMwVbRlvRazGxdH91/XOgWtToa0bk982o7u5RDZbpazaoueeNjqovHBZ7dQmk1yI2v0VZSuxcE2No3SGcn/qcDjrPU4pwlfRfTdW5xn6IYlRulnle18vsXlJy1XOayeAnifD8RD7uU12abcj3oKe+gefPS6HrxcVXErSWDKlMXkccMB7yquHAOHATMPAMseAH9w5dPm6pnPD0U5/hs9JdLAyQ16276USSM0LSxmIF4N2eF0XBUS5/gKkzaXqxJ9OdAuSHPYTeElX05IDRT1AFu9rfr7NFhMytMVQ28TASpX+idETMDCnQ7EqLOxi/8SZ84ByRZB+VKhPC+dPSRRWhwa0qUkf2tDPeuhTMTEyUHxfGr9e+nbFNxparaodDI3C9CMsZxzb8te5kQwVxOwW7NVGiax5oKnFNAsUqqim9EKJmCvmsSJefjUQaczRG2UJ1HI5CWt5dWdhr+8LyEwo9KEhU+mCb9cyvv8MwV3yCafMEMfiIbAZ3160mvxv4LZBlBIWCdO3exaOiUX0wPdbi7FLVhSIsAVfsIKP8pzx0Piw7gj4n52IFGlKaO3e4SkTDxdUW0N/LGAYfyp/me4lff6hXDQEiXjBCHeBC7baCB8+OU30JxBUtuye7iGhDtqZCLmurzjwUBaqiOLktEysoELQ33ec4yjmWNJScaGNwE6cPLdoj/0jMWFZDMRFOCdfxqmCWtVw2zSAyYdaf5q/l0c6FvKktKzg8e2rjJYs7P+NC4Z0RM6M4W/V+k3cp+S6UnJPeO6JvzYxR3IFm784CDalFbdzI5KobnzWiT9bs3iV8EsBBufX3sv0ij9BEuISFPrpKLTLo24RK5FfuES/Sl1Mk/xaaWzbsZb0AU9s6xjQxwXLGL4iBVkLK0ae18z5+xM96TAVTXtCVbmaBMM7YQOGk1y/jz/Zw==
  template:
    metadata:
      name: home-assistant
      namespace: default
    type: Opaque
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: home-assistant
  namespace: default
  labels:
    name: home-assistant
spec:
  capacity:
    storage: 1Pi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /mnt/data/apps/kubernetes/home-assistant
    server: callisto.kiski.co
  mountOptions:
  - nfsvers=4.1
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: home-assistant
  namespace: default
spec:
  selector:
    matchLabels:
      name: home-assistant
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Pi
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: home-assistant
  namespace: default
# home-assistant is dumb and doesn't make "external" config management easy.
# the container assumes that the application directory ("/config"), is RW
# and will use this directory for storing all types of stuff outside of the DB.
# Due to the RW requirement, all configmaps or secrets must be mounted using
# subpath. Unfortunately we can't simply drop a Projected Volume into /config.
# (another annoying tidbit, there isn't an easy way to skip onboard or
# precreate users.)
data:
  known_devices.yaml: |
    mia2:
      hide_if_away: false
      icon:
      mac: !secret mia2_mac
      name: Jacob
      picture:
      track: true
      vendor: unknown
      gravatar: !secret mia2_gravatar
    lila:
      hide_if_away: false
      icon:
      mac: !secret lila_mac
      name: Emily
      picture:
      track: true
      vendor: Apple, Inc.
      gravatar: !secret lila_gravatar
  # this onboarding file is generated after the manual onboarding has been
  # completed. I had to manually generate this and then copy it out of the
  # container.
  # Note that it's also very specific to 0.93.2
  onboarding: |
    {
        "data": {
            "done": [
                "user",
                "integration"
            ]
        },
        "key": "onboarding",
        "version": 2
    }
  configuration.yaml: |
    homeassistant:
      name: Home
      latitude: !secret latitude
      longitude: !secret longitude
      elevation: 30
      unit_system: imperial
      time_zone: America/New_York
      customize:
        switch.leviton_dzpa1_1lw_plug_in_appliance_module_switch:
          friendly_name: Christmas Tree
          icon: mdi:pine-tree
        switch.leviton_dzpa1_1lw_plug_in_appliance_module_switch_2:
          friendly_name: Nightstand Light
          icon: mdi:weather-night
        light.linear_nortek_security_control_llc_lb60z_1_dimmable_led_light_bulb_level:
          friendly_name: Norpoc Light
      customize_domain:
        zwave:
          hidden: true
      customize_glob:
        "sensor.hank*":
          hidden: true
        "binary_sensor.hank_unknown*":
          hidden: true
      auth_providers:
        - type: homeassistant
    frontend:
    config:
    discovery:
      ignore:
        - plex_mediaserver
        - google_cast
    history:
    logbook:
    map:
    sensor:
      - platform: nut
        name: UPS
        host: callisto.kiski.co
        alias: ups
        username: monuser
        password: !secret ups_password
        resources:
          - ups.status
          - battery.charge
          - battery.runtime
          - ups.load
      - platform: plex
        host: plex.kiski.co
        port: 32400
        name: Plex
        token: !secret plex_token
    group:
      living_room:
        name: Living Room
        entities:
          - light.linear_nortek_security_control_llc_lb60z_1_dimmable_led_light_bulb_level
          - light.living_room_floor_lamp
          - binary_sensor.apartment_door_sensor
          - media_player.double_r_diner
          - switch.leviton_dzpa1_1lw_plug_in_appliance_module_switch
      bedroom:
        name: Bedroom
        entities:
          - switch.leviton_dzpa1_1lw_plug_in_appliance_module_switch_2
      office:
        name: Office
        entities:
          - light.office_sphere
          - sensor.ups_status_data
          - sensor.ups_battery_charge
          - sensor.ups_battery_runtime
          - sensor.ups_load
          - sensor.plex
    automation:
      - alias: 'Turn off all lights when nobody is home'
        hide_entity: true
        trigger:
          platform: state
          entity_id: group.all_devices
          to: 'not_home'
        action:
          - service: switch.turn_off
            entity_id: group.all_switches
          - service: light.turn_off
            entity_id: group.all_lights
      - alias: 'Turn on all lights when Emily arrives home'
        hide_entity: true
        trigger:
          platform: state
          from: not_home
          to: home
          entity_id: device_tracker.lila
        action:
          - service: switch.turn_on
            entity_id: group.living_room
          - service: light.turn_on
            entity_id: group.living_room
      - alias: 'Turn on all lights when Jacob arrives home'
        hide_entity: true
        trigger:
          platform: state
          from: not_home
          to: home
          entity_id: device_tracker.mia2
        action:
          - service: switch.turn_on
            entity_id: group.living_room
          - service: light.turn_on
            entity_id: group.living_room
      - alias: 'Notify about presence detection'
        hide_entity: true
        trigger:
          platform: state
          entity_id: device_tracker.mia2, device_tracker.lila
        action:
          service: notify.all
          data_template:
            message: "{{trigger.to_state.attributes.friendly_name}} changed state from {{trigger.from_state.state}} to {{trigger.to_state.state}}"
        condition:
          - condition: template
            value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
      - alias: 'Notify about UPS state change'
        hide_entity: true
        trigger:
          platform: state
          entity_id: sensor.ups_status_data
        action:
          service: notify.all
          data_template:
            message: "UPS changed state from {{trigger.from_state.attributes.state}} to {{trigger.to_state.attributes.state}}"
      - alias: 'Apartment door opened when nobody home'
        hide_entity: true
        trigger:
          platform: state
          entity_id: binary_sensor.apartment_door_sensor
          to: 'on'
        condition:
          - condition: state
            entity_id: group.all_devices
            state: 'not_home'
        action:
          - service: notify.all
            data_template:
              message: "Apartment door opened when nobody is home."
          - service: switch.turn_on
            entity_id: group.living_room
          - service: light.turn_on
            entity_id: group.living_room
    zwave:
      usb_path: /dev/ttyUSB0
      network_key: !secret zwave_network_key
    device_tracker:
      - platform: unifi
        username: homeassistant
        password: !secret unifi_password
        host: unifi.wellesleynet.com
        new_device_defaults:
          track_new_devices: False
    lifx:
      light:
        - broadcast: 192.168.67.148
        - broadcast: 192.168.67.153
    scene:
      platform: lifx_cloud
      token: !secret lifx_cloud_token
    notify:
      - name: gmail
        platform: smtp
        sender: jyundt@gmail.com
        recipient: jyundt@gmail.com
        server: smtp.gmail.com
        sender_name: "home-assistant"
        username: jyundt@gmail.com
        password: !secret gmail_smtp_password
      - name: pushover
        platform: pushover
        api_key: !secret pushover_api_key
        user_key: !secret pushover_user_key
      - name: all
        platform: group
        services:
          - service: pushover
    alert:
      ups_on_battery:
        name: UPS running on battery power
        entity_id: sensor.ups_status_data
        state: "OB"
        repeat: 5
        can_acknowledge: true
        skip_first: true
        notifiers:
          - all
      ups_low_battery:
        name: UPS battery critically low
        entity_id: sensor.ups_status_data
        state: "LB"
        repeat: 5
        can_acknowledge: true
        skip_first: true
        notifiers:
          - all
      apartment_door_open:
        name: Apartment door open for >5 minutes
        done_message: Apartment door has been closed
        entity_id: binary_sensor.apartment_door_sensor
        repeat: 5
        can_acknowledge: true
        skip_first: true
        notifiers:
          - all
    binary_sensor:
      - platform: template
        sensors:
          apartment_door_sensor:
            device_class: door
            friendly_name: 'Apartment Door'
            value_template: "{{ is_state('sensor.hank_unknown_type0201_id0008_access_control', '22') }}"
    recorder:
      purge_interval: 0
      db_url: sqlite:////db/home-assistant.db
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: home-assistant
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: home-assistant
  serviceName: "home-assistant"
  template:
    metadata:
      labels:
        app: home-assistant
    spec:
      containers:
      # More recent versions of home-assistant are awful. They require the
      # WebUI to configure integrations (Uniif) and are extremely hostile to
      # using yaml + SCM for configuration. e.g. everything in json under
      # "/config/.storage".
      - image: homeassistant/home-assistant:0.93.2
        imagePullPolicy: Always
        name: home-assistant
        ports:
        - containerPort: 8123
        livenessProbe:
          tcpSocket:
            port: 8123
        volumeMounts:
        - name: home-assistant-config
          mountPath: /config/configuration.yaml
          subPath: configuration.yaml
        - name: home-assistant-secrets
          mountPath: /config/secrets.yaml
          subPath: secrets.yaml
        - name: home-assistant-config
          mountPath: /config/known_devices.yaml
          subPath: known_devices.yaml
        - name: home-assistant-config
          mountPath: /config/.storage/onboarding
          subPath: onboarding
        - name: home-assistant-secrets
          mountPath: /config/.storage/auth_provider.homeassistant
          subPath: auth_provider.homeassistant
        - name: home-assistant-data
          mountPath: /db
        - name: home-assistant-usb0
          mountPath: /dev/ttyUSB0
        - name: home-assistant-usb1
          mountPath: /dev/ttyUSB1
        securityContext:
          privileged: true
      nodeSelector:
        has_zwave_dongle: "true"
      volumes:
      - name: home-assistant-config
        configMap:
          name: home-assistant
      - name: home-assistant-secrets
        secret:
          secretName: home-assistant
      - name: home-assistant-data
        persistentVolumeClaim:
          claimName: home-assistant
      - name: home-assistant-usb0
        hostPath:
          path: /dev/ttyUSB0
          type: CharDevice
      - name: home-assistant-usb1
        hostPath:
          path: /dev/ttyUSB1
          type: CharDevice
---
apiVersion: v1
kind: Service
metadata:
  namespace: default
  name: home-assistant
spec:
  selector:
    app: home-assistant
  ports:
  - name: home-assistant
    port: 8123
    protocol: TCP
    targetPort: 8123
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: home-assistant
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/auth-url: https://$host/oauth2/auth
    nginx.ingress.kubernetes.io/auth-signin: https://$host/oauth2/start?rd=$escaped_request_uri
    nginx.ingress.kubernetes.io/backend-protocol: HTTP
spec:
  rules:
  - host: avcad.kiski.co
    http:
      paths:
      - backend:
          serviceName: home-assistant
          servicePort: 8123
  tls:
  - hosts:
    - avcad.kiski.co
    secretName: kiskico-wildcard
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: home-assistant-oauth2
  namespace: default
spec:
  tls:
  - hosts:
    - avcad.kiski.co
    secretName: kiskico-wildcard
  rules:
  - host: avcad.kiski.co
    http:
      paths:
      - path: /oauth2
        backend:
          serviceName: oauth2-proxy
          servicePort: 4180
